angular.module("dndLists",[]).directive("dndDraggable",["$parse","$timeout","dndDropEffectWorkaround","dndDragTypeWorkaround","$window",function(e,n,r,t,a){return function(d,o,i){o.attr("draggable","true"),i.dndDisableIf&&d.$watch(i.dndDisableIf,function(e){o.attr("draggable",!e)}),o.on("dragstart",function(f){f=f.originalEvent||f;var l=d.$eval(i.dndDraggable);f.dataTransfer.setData("Text",angular.toJson(l)),a["dndList.draggedData"]=l,f.dataTransfer.effectAllowed=i.dndEffectAllowed||"move",o.addClass("dndDragging"),n(function(){o.addClass("dndDraggingSource")},0),r.dropEffect="none",t.isDragging=!0,t.dragType=i.dndType?d.$eval(i.dndType):void 0,e(i.dndDragstart)(d,{event:f}),f.stopPropagation()}),o.on("dragend",function(a){a=a.originalEvent||a;var f=r.dropEffect;d.$apply(function(){switch(f){case"move":e(i.dndMoved)(d,{event:a});break;case"copy":e(i.dndCopied)(d,{event:a});break;case"none":e(i.dndCanceled)(d,{event:a})}e(i.dndDragend)(d,{event:a,dropEffect:f})}),o.removeClass("dndDragging"),n(function(){o.removeClass("dndDraggingSource")},0),t.isDragging=!1,a.stopPropagation()}),o.on("click",function(n){i.dndSelected&&(n=n.originalEvent||n,d.$apply(function(){e(i.dndSelected)(d,{event:n})}),n.stopPropagation())}),o.on("selectstart",function(){this.dragDrop&&this.dragDrop()})}}]).directive("dndList",["$parse","$timeout","dndDropEffectWorkaround","dndDragTypeWorkaround","$window",function(e,n,r,t,a){return function(d,o,i){function f(e,n,r){var t=y?e.offsetX||e.layerX:e.offsetY||e.layerY,a=y?n.offsetWidth:n.offsetHeight,d=y?n.offsetLeft:n.offsetTop;return d=r?d:0,d+a/2>t}function l(){var e;return angular.forEach(o.children(),function(n){var r=angular.element(n);r.hasClass("dndPlaceholder")&&(e=r)}),e||angular.element("<li class='dndPlaceholder'></li>")}function g(){return Array.prototype.indexOf.call(E.children,D)}function s(e){if(!t.isDragging&&!T)return!1;if(!p(e.dataTransfer.types))return!1;if(i.dndAllowedTypes&&t.isDragging){var n=d.$eval(i.dndAllowedTypes);if(angular.isArray(n)&&-1===n.indexOf(t.dragType))return!1}return i.dndDisableIf&&d.$eval(i.dndDisableIf)?!1:!0}function u(){return v.remove(),o.removeClass("dndDragover"),!0}function c(n,r,a,o){return e(n)(d,{event:r,index:a,item:o||void 0,external:!t.isDragging,type:t.isDragging?t.dragType:void 0})}function p(e){if(!e)return!0;for(var n=0;n<e.length;n++)if("Text"===e[n]||"text/plain"===e[n])return!0;return!1}var v=l(),D=v[0],E=o[0];v.remove();var y=i.dndHorizontalList&&d.$eval(i.dndHorizontalList),T=i.dndExternalSources&&d.$eval(i.dndExternalSources);o.on("dragover",function(e){if(e=e.originalEvent||e,!s(e))return!0;if(D.parentNode!=E&&o.append(v),e.target!==E){for(var n=e.target;n.parentNode!==E&&n.parentNode;)n=n.parentNode;n.parentNode===E&&n!==D&&(f(e,n)?E.insertBefore(D,n):E.insertBefore(D,n.nextSibling))}else if(f(e,D,!0))for(;D.previousElementSibling&&(f(e,D.previousElementSibling,!0)||0===D.previousElementSibling.offsetHeight);)E.insertBefore(D,D.previousElementSibling);else for(;D.nextElementSibling&&!f(e,D.nextElementSibling,!0);)E.insertBefore(D,D.nextElementSibling.nextElementSibling);return i.dndDragover&&!c(i.dndDragover,e,g())?u():(o.addClass("dndDragover"),e.preventDefault(),e.stopPropagation(),!1)}),o.on("drop",function(e){if(e=e.originalEvent||e,!s(e))return!0;e.preventDefault();var t=a["dndList.draggedData"];if(void 0===t){var o=e.dataTransfer.getData("Text")||e.dataTransfer.getData("text/plain");try{t=JSON.parse(o)}catch(f){return u()}}var l=g();if(i.dndDrop&&(t=c(i.dndDrop,e,l,t),!t))return u();var p=d.$eval(i.dndList);return n(function(){p.splice(l,0,t),c(i.dndInserted,e,l,t)},0),r.dropEffect="none"===e.dataTransfer.dropEffect?"copy"===e.dataTransfer.effectAllowed||"move"===e.dataTransfer.effectAllowed?e.dataTransfer.effectAllowed:e.ctrlKey?"copy":"move":e.dataTransfer.dropEffect,u(),e.stopPropagation(),!1}),o.on("dragleave",function(e){e=e.originalEvent||e,o.removeClass("dndDragover"),n(function(){o.hasClass("dndDragover")||v.remove()},100)})}}]).directive("dndNodrag",function(){return function(e,n){n.attr("draggable","true"),n.on("dragstart",function(e){e=e.originalEvent||e,e.dataTransfer.types&&e.dataTransfer.types.length||e.preventDefault(),e.stopPropagation()}),n.on("dragend",function(e){e=e.originalEvent||e,e.stopPropagation()})}}).factory("dndDragTypeWorkaround",function(){return{}}).factory("dndDropEffectWorkaround",function(){return{}});

angular.module("dndLists",[]).directive("dndDraggable",["$parse","$timeout","dndDropEffectWorkaround","dndDragTypeWorkaround",function(e,n,r,t){return function(a,d,i){var o;if(i.dndDisableIf){a.$watch(i.dndDisableIf,function(e){d.attr("draggable",!e)})}d.on("mousedown",function(e){o=e.target;if(!i.dndHandleClass||o.classList.contains(i.dndHandleClass)){d.attr("draggable","true")}else{d.attr("draggable","false")}});d.on("dragstart",function(f){if(i.dndHandleClass&&!o.classList.contains(i.dndHandleClass)){f.preventDefault();return}f=f.originalEvent||f;f.dataTransfer.setData("Text",angular.toJson(a.$eval(i.dndDraggable)));f.dataTransfer.effectAllowed=i.dndEffectAllowed||"move";d.addClass("dndDragging");n(function(){d.addClass("dndDraggingSource")},0);r.dropEffect="none";t.isDragging=true;t.dragType=i.dndType?a.$eval(i.dndType):undefined;e(i.dndDragstart)(a,{event:f});f.stopPropagation()});d.on("dragend",function(n){n=n.originalEvent||n;var o=r.dropEffect;a.$apply(function(){switch(o){case"move":e(i.dndMoved)(a,{event:n});break;case"copy":e(i.dndCopied)(a,{event:n});break}});d.removeClass("dndDragging");d.removeClass("dndDraggingSource");t.isDragging=false;n.stopPropagation()});d.on("click",function(n){n=n.originalEvent||n;a.$apply(function(){e(i.dndSelected)(a,{event:n})})})}}]).directive("dndList",["$parse","$timeout","dndDropEffectWorkaround","dndDragTypeWorkaround",function(e,n,r,t){return function(a,d,i){var o=angular.element("<li class='dndPlaceholder'></li>");var f=o[0];var l=d[0];var s=i.dndHorizontalList&&a.$eval(i.dndHorizontalList);var g=i.dndExternalSources&&a.$eval(i.dndExternalSources);d.on("dragover",function(e){e=e.originalEvent||e;if(!p(e))return true;if(f.parentNode!=l){d.append(o)}if(e.target!==l){var n=e.target;while(n.parentNode!==l&&n.parentNode){n=n.parentNode}if(n.parentNode===l&&n!==f){if(u(e,n)){l.insertBefore(f,n)}else{l.insertBefore(f,n.nextSibling)}}}else{if(u(e,f,true)){while(f.previousElementSibling&&(u(e,f.previousElementSibling,true)||f.previousElementSibling.offsetHeight===0)){l.insertBefore(f,f.previousElementSibling)}}else{while(f.nextElementSibling&&!u(e,f.nextElementSibling,true)){l.insertBefore(f,f.nextElementSibling.nextElementSibling)}}}if(i.dndDragover&&!D(i.dndDragover,e)){return v()}d.addClass("dndDragover");e.preventDefault();e.stopPropagation();return false});d.on("drop",function(e){e=e.originalEvent||e;if(!p(e))return true;e.preventDefault();var n=e.dataTransfer.getData("Text")||e.dataTransfer.getData("text/plain");var t;try{t=JSON.parse(n)}catch(d){return v()}if(i.dndDrop){t=D(i.dndDrop,e,t);if(!t){return v()}}var o=a.$eval(i.dndList);a.$apply(function(){o.splice(c(),0,t)});if(e.dataTransfer.dropEffect==="none"){if(e.dataTransfer.effectAllowed==="copy"||e.dataTransfer.effectAllowed==="move"){r.dropEffect=e.dataTransfer.effectAllowed}else{r.dropEffect=e.ctrlKey?"copy":"move"}}else{r.dropEffect=e.dataTransfer.dropEffect}v();e.stopPropagation();return false});d.on("dragleave",function(e){e=e.originalEvent||e;d.removeClass("dndDragover");n(function(){if(!d.hasClass("dndDragover")){o.remove()}},100)});function u(e,n,r){var t=s?e.offsetX||e.layerX:e.offsetY||e.layerY;var a=s?n.offsetWidth:n.offsetHeight;var d=s?n.offsetLeft:n.offsetTop;d=r?d:0;return t<d+a/2}function c(){return Array.prototype.indexOf.call(l.children,f)}function p(e){if(!t.isDragging&&!g)return false;if(!y(e.dataTransfer.types))return false;if(i.dndAllowedTypes&&t.isDragging){var n=a.$eval(i.dndAllowedTypes);if(angular.isArray(n)&&n.indexOf(t.dragType)===-1){return false}}if(i.dndDisableIf&&a.$eval(i.dndDisableIf))return false;return true}function v(){o.remove();d.removeClass("dndDragover");return true}function D(n,r,d){return e(n)(a,{event:r,index:c(),item:d||undefined,external:!t.isDragging,type:t.isDragging?t.dragType:undefined})}function y(e){if(!e)return true;for(var n=0;n<e.length;n++){if(e[n]==="Text"||e[n]==="text/plain")return true}return false}}}]).factory("dndDragTypeWorkaround",function(){return{}}).factory("dndDropEffectWorkaround",function(){return{}});